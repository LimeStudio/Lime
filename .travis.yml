language: android
jdk: oraclejdk8
sudo: required
env:
  global:
  - ANDROID_API=28
  - EMULATOR_API=21
  - ANDROID_BUILD_TOOLS=28.0.2
  - ADB_INSTALL_TIMEOUT=5
  # auto-create ->   travis encrypt storepass=YOUR_STORE_PASSWORD --add env.global
  #                  travis encrypt keypass=YOUR_KEY_PASSWORD --add env.global
  - secure: HGoHbd0ZO8RJjDJGKJfG/KYKlm8BEsAa8r6CaDovt6lSWOnsO+uZ8KPZA4hgHAPd+9TJCYZb0LvvP+AlCLvRhBgjjF925tnY8JRay0ImUlvK+p/jdeK2ywlQe/c2AGPGmik/ZfBxaH59vwBwmTfO5pW7edLqAH2C2jTdgPEL1eDUc6/rvVo7PJ8XtGQKgtF79VZFabp0mEpgjT4IU41Jv/JTy9Bfm8RWdOK24oxXxYCf+FqBRQeHXxzvgj1r5Nv0aNuQOc5az0wJOtpfWtq1+69DlVpz8c/1x6J73QW9Vr8M5ohWJYwQcY5iTJql4CulRRZg8O4M2LueVGhp3U6U5eqM/HK86N+8SvmylFDaOOSt5iwedwxAKxK9ANPnTfcZOw2OnjBqULJneLcCITFVEvFjQlBzlaW9q6fYfXgenh6elALNzt23ccqofezHoxy0ICdBa2VuYHulXko///7wZ4KViAAvJ4j5Fz1WqU15Gfo6iMqok4vAgxm9/EfHnTsGkm0YXOsrJMVXlr/y4TOHMBF1QrbiHihSqwWfn8rbMiM64AxKrC5/96hXDqTnfbXZJlvWNnA6VLcMOG85DCTQHnZ91WnEemdaP60Zf+XCd3Rvvl1ZzlVK2s92sCU7vB9XWALvAZWIaXT+iQkC6XlUBYIe7RAk82mN1HnycDYOs8g=
  - secure: M7KpFp7VFbivN/UF9MZfxL7ZxdBJXN6W2RStu25/JvwTQ8bmvWV7rGvnpPufs0PBh+0SU63CRADf5SN0ND29KjA7N/DYUloTL2OVc6JsYgGPRqBna3wAVXjqAobLxwZO0A50XpnBjycoj88brAQyzAn7zPjlPtTu1OSYwuc+vxu8hSAatv2igbOYGIA2QVAsxDpJi89ZyPn9VBx+vnRH3r3ER+Jw3+We3u0VAk7lE358aEHMG+QD2Nt9DxHU7vZQb2YsGfDkt8r1CQ1lGH0ZB/MMLQFDK/w9iUwCGZT6KpQajuHHcfFWevQfWL1QVm8fGELDiBKD8Phy+AUi+LG+F7W6e7Z1HmLY4ES6tMtb6+BauhJRZXPmFlRkIZRbDYl0S8bypqZkxPtjEkqrD1Ws6tfr8LA9k6uH2WbxBAFiRPqOkNf0/hDcDuMhY/kyKReScmaAsYXoqAA+w0vUJV3jvq2EJKzgK97V9e4XEDOqU4EUdMt91rkHbydM6E9VUvOHUST5HuIkI5QqJ5+nLJyl8NxzTiXpLVXPa7RpAGg1CTAx52NccXA2kjEbwGJzktTPUJnPSp6UzEbvtUjtyRBMpNwlmvPLYdl6Z9qrSxG5mraaAgsId3V86vBft7QElxgT5wRb5d0ADtJgKrpLUjNI5qoND3aYv9vMo8n0ZImYoQ8=
android:
  components:
  - tools
  - platform-tools
  - build-tools-$ANDROID_BUILD_TOOLS
  - android-$ANDROID_API
  - android-$EMULATOR_API
  - extra-google-m2repository
  - extra-android-m2repository
  - sys-img-armeabi-v7a-android-$ANDROID_API
  - sys-img-armeabi-v7a-android-$EMULATOR_API
  licenses:
  - android-sdk-preview-license-.+
  - android-sdk-license-.+
  - google-gdk-license-.+

before_cache:
- rm -f $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:                   #指定缓存目录
 directories:
 - $HOME/.gradle/caches/
 - $HOME/.gradle/wrapper/


before_script:
  - echo no | android create avd --force -n test -t android-21 --abi armeabi-v7a
  - emulator -avd test -no-audio -no-window &
  - android-wait-for-emulator
  #- adb shell input keyevent 82

before_install:
  # auto-create-start -> travis encrypt-file appkey.jks
  - openssl aes-256-cbc -K $encrypted_1fefb9d6120c_key -iv $encrypted_1fefb9d6120c_iv -in appkey.jks.enc -out appkey.jks -d
  # let gradlew access permission
  - chmod +x gradlew
  - cd $TRAVIS_BUILD_DIR
  - wget -c https://raw.githubusercontent.com/Pgyer/TravisFile/master/pgyer_upload.sh -O pgyer_upload.sh
  - chmod +x pgyer_upload.sh

script:
  #- ./gradlew clean build connectedCheck -PdisablePreDex --stacktrace"
  - ./gradlew assembleRelease

after_success:
  - cp $TRAVIS_BUILD_DIR/appkey.jks $HOME
  - cd $TRAVIS_BUILD_DIR/app/build/outputs/apk/release
  - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/appkey.jks
  - storepass $storepass -keypass $keypass app-release-unsigned.apk lime
  - jarsigner -verify app-release-unsigned.apk
  - "${ANDROID_HOME}/build-tools/26.0.2/zipalign -v 4 app-release-unsigned.apk lime.apk"


after_script:
- set -e
- $TRAVIS_BUILD_DIR/pgyer_upload.sh "${TRAVIS_BUILD_DIR}/app/build/outputs/apk/release/lime.apk"
  "318e91cdb7e069286d1dcc56acfe203a"
- rm $TRAVIS_BUILD_DIR/pgyer_upload.sh
